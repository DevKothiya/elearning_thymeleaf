<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Update Course</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" >
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Attach event listeners to existing "Remove This Lesson" buttons
            document.querySelectorAll('.remove-lesson').forEach(button => {
                button.addEventListener('click', function () {
                    const lessonDiv = this.closest('.lesson');
                    removeLesson(lessonDiv);
                });
            });
        });

        function addLesson(existingLesson = null) {
            const lessonsContainer = document.getElementById('lessons-container');
            const lessonIndex = lessonsContainer.children.length;

            const lessonDiv = document.createElement('div');
            lessonDiv.className = 'lesson mb-3';
            lessonDiv.setAttribute('data-index', lessonIndex); // Store index for removal

            // Set default values for existing lessons, if any
            const lessonTitle = existingLesson ? existingLesson.title : '';
            const lessonContent = existingLesson ? existingLesson.content : '';
            const lessonDuration = existingLesson ? existingLesson.duration : '';

            lessonDiv.innerHTML = `
                <div class="form-group">
                    <label for="lessons[${lessonIndex}].title">Lesson Title:</label>
                    <input type="text" class="form-control" name="lessons[${lessonIndex}].title" value="${lessonTitle}" required />
                </div>
                <div class="form-group">
                    <label for="lessons[${lessonIndex}].content">Lesson Content:</label>
                    <textarea class="form-control" name="lessons[${lessonIndex}].content" rows="3" required>${lessonContent}</textarea>
                </div>
                <div class="form-group">
                    <label for="lessons[${lessonIndex}].duration">Lesson Duration (minutes):</label>
                    <input type="number" class="form-control" name="lessons[${lessonIndex}].duration" value="${lessonDuration}" min="1" required />
                </div>
                <button type="button" class="btn btn-danger remove-lesson">Remove This Lesson</button>
                <hr />
            `;

            lessonsContainer.appendChild(lessonDiv);

            // Add event listener to remove the current lesson when clicking the button
            lessonDiv.querySelector('.remove-lesson').addEventListener('click', function () {
                removeLesson(lessonDiv);
            });
        }

       function removeLesson(lessonDiv) {
    const lessonsContainer = document.getElementById('lessons-container');
    if (lessonsContainer.contains(lessonDiv)) {
        lessonsContainer.removeChild(lessonDiv);
    } else {
        console.error('Lesson to be removed is not a child of the lessons container.');
    }

    // Reindex remaining lessons
    Array.from(lessonsContainer.children).forEach((lesson, index) => {
        const lessonInputs = lesson.querySelectorAll('input, textarea');
        lessonInputs.forEach(input => {
            const name = input.getAttribute('name');
            input.setAttribute('name', name.replace(/\[\d+\]/, `[${index}]`));
        });
    });
}

    </script>

</head>
<body class="container mt-5">
<h1 class="mb-4">Update Course</h1>
<form th:action="@{/instructor/courses/addCourse}" th:method="post">
    <input type="hidden" name="id" th:value="${course.id}">
    <div class="form-group">
        <label for="title">Course Title:</label>
        <input type="text" class="form-control" id="title" name="title" th:value="${course.title}" required />
    </div>
    <div class="form-group">
        <label for="description">Course Description:</label>
        <textarea class="form-control" id="description" name="description" rows="4" required th:text="${course.description}"></textarea>
    </div>
    <div class="form-group">
        <label for="category">Course Category:</label>
        <input type="text" class="form-control" id="category" name="category" th:value="${course.category}" required />
    </div>
    <div class="form-group">
        <label for="price">Course Price:</label>
        <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" th:value="${course.price}" />
    </div>

    <h2 class="mt-4">Lessons</h2>
    <div id="lessons-container">
        <!-- Thymeleaf loop to render existing lessons -->
        <div th:each="lesson, iterStat : ${course.lessons}">
            <div class="lesson mb-3" th:data-index="${iterStat.index}">
                <div class="form-group">
                    Lesson Title:
                    <input type="text" class="form-control" th:name="'lessons[' + ${iterStat.index} + '].title'" th:value="${lesson.title}" required />
                </div>
                <div class="form-group">
                    Lesson Content:
                    <textarea class="form-control" th:name="'lessons[' + ${iterStat.index} + '].content'" rows="3" required th:text="${lesson.content}"></textarea>
                </div>
                <div class="form-group">
                    Lesson Duration (minutes):
                    <input type="number" class="form-control" th:name="'lessons[' + ${iterStat.index} + '].duration'" th:value="${lesson.duration}" min="1" required />
                </div>
                <button type="button" class="btn btn-danger remove-lesson">Remove This Lesson</button>
                <hr />
            </div>
        </div>
    </div>

    <div class="mb-3">
        <button type="button" class="btn btn-primary" onclick="addLesson()">Add Lesson</button>
    </div>

    <div>
        <button type="submit" class="btn btn-success">Save Course</button>
    </div>
</form>
</body>
</html>
